<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auto-Deploy to Cloud Run with Cloud Build</title>
</head>
<body>
    <h1>🚀 Auto-Deploy to Cloud Run with Cloud Build on Git Push – Step-by-Step Guide</h1>
    <p>In today’s DevOps-driven world, automating deployments is essential for speed, reliability, and scalability. In this guide, you'll learn how to automatically deploy an application to Google Cloud Run using Cloud Build, triggered whenever new changes are pushed to your Git repository.</p>

    <p>This setup ensures your application is always up to date in production, with no manual steps involved.</p>

    <h2>🔧 Prerequisites</h2>
    <ul>
        <li>A Google Cloud Project with billing enabled</li>
        <li><code>gcloud</code> CLI installed and initialized</li>
        <li>A GitHub or Cloud Source Repository containing your app code</li>
        <li>A Dockerfile (or a standard runtime like Node.js, Python, etc.)</li>
        <li>Basic IAM permissions: Cloud Build Editor, Cloud Run Admin, Service Account User</li>
    </ul>

    <h2>✅ Step 1: Enable Required Google Cloud APIs</h2>
    <pre><code>gcloud services enable \
  run.googleapis.com \
  cloudbuild.googleapis.com \
  artifactregistry.googleapis.com
</code></pre>

    <h2>🗂️ Step 2: Prepare Your Application and Repository</h2>
    <p>Let’s create a simple app (Python example):</p>

    <h3><code>main.py</code></h3>
    <pre><code>from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello from Cloud Run!'

if __name__ == '__main__':
    app.run()</code></pre>

    <h3><code>requirements.txt</code></h3>
    <pre><code>flask</code></pre>

    <h3><code>Dockerfile</code></h3>
    <pre><code>FROM python:3.10-slim
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt
CMD ["python", "main.py"]</code></pre>

    <h2>🛠️ Step 3: Add Cloud Build Configuration (cloudbuild.yaml)</h2>
    <p>Create a file named <code>cloudbuild.yaml</code> in your project root:</p>
    <pre><code>steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/my-app', '.']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/my-app']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run', 'deploy', 'my-app',
        '--image', 'gcr.io/$PROJECT_ID/my-app',
        '--region', 'us-central1',
        '--platform', 'managed',
        '--allow-unauthenticated'
      ]
</code></pre>

    <h2>🌐 Step 4: Push Your Code to GitHub or Cloud Source Repositories</h2>
    <pre><code>git init
git remote add origin https://github.com/your-user/your-repo.git
git add .
git commit -m "Initial commit"
git push -u origin main</code></pre>

    <h2>🔐 Step 5: Grant IAM Permissions to Cloud Build</h2>
    <pre><code>PROJECT_ID=$(gcloud config get-value project)
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format='value(projectNumber)')

gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"</code></pre>

    <h2>🔄 Step 6: Create a Cloud Build Trigger</h2>
    <h3>🧭 Steps to Create Trigger via Cloud Console:</h3>
    <ol>
        <li>Go to <a href="https://console.cloud.google.com/cloud-build/triggers" target="_blank">Cloud Console → Cloud Build → Triggers</a></li>
        <li>Click <strong>Create Trigger</strong></li>
        <li><strong>Repository Type:</strong> GitHub (or Cloud Source Repositories)</li>
        <li><strong>Repository:</strong> Choose your linked repo</li>
        <li><strong>Trigger Name:</strong> auto-deploy-cloudrun</li>
        <li><strong>Event:</strong> Push to a branch</li>
        <li><strong>Branch (Regex):</strong> <code>^main$</code></li>
        <li><strong>Build Configuration:</strong> <code>cloudbuild.yaml</code> at root</li>
        <li>Click <strong>Create</strong></li>
    </ol>

    <p><strong>✅ Result:</strong> Your app will now build and deploy automatically when new commits are pushed to the main branch.</p>

    <h2>🧪 Step 7: Test the CI/CD Pipeline</h2>
    <pre><code>git add .
git commit -m "Update hello message"
git push origin main</code></pre>

    <p>Watch the build in <strong>Cloud Console → Cloud Build → History</strong>.</p>

    <h2>🌍 Step 8: Access Your Cloud Run App</h2>
    <pre><code>gcloud run services describe my-app \
  --region us-central1 \
  --platform managed \
  --format='value(status.url)'</code></pre>
    <p>Open the URL in your browser—you should see your updated app live!</p>

    <h2>📌 Summary</h2>
    <table border="1" cellpadding="5">
        <thead>
            <tr><th>Step</th><th>Task</th></tr>
        </thead>
        <tbody>
            <tr><td>✅ 1</td><td>Enable APIs</td></tr>
            <tr><td>✅ 2</td><td>Prepare your app and repo</td></tr>
            <tr><td>✅ 3</td><td>Add cloudbuild.yaml</td></tr>
            <tr><td>✅ 4</td><td>Push to Git</td></tr>
            <tr><td>✅ 5</td><td>Set IAM permissions</td></tr>
            <tr><td>✅ 6</td><td>Create Cloud Build trigger</td></tr>
            <tr><td>✅ 7</td><td>Push code and test</td></tr>
            <tr><td>✅ 8</td><td>Access your live Cloud Run service</td></tr>
        </tbody>
    </table>

    <h2>🎯 Conclusion</h2>
    <p>You now have a complete, production-grade CI/CD pipeline using:</p>
    <ul>
        <li><strong>Google Cloud Run</strong> – scalable serverless platform</li>
        <li><strong>Cloud Build</strong> – automated build/deploy service</li>
        <li><strong>Git</strong> – version-controlled code as the trigger</li>
    </ul>
    <p>Every push to your GitHub main branch now results in an automatic build and deployment to Cloud Run, with no manual steps required.</p>

    <p>🔄 Modern DevOps starts with automation. This setup gets you there—fast.</p>
</body>
</html>
